<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>JS-XLSX</title>
    <style>
        #log {
            position: fixed;
            min-height: 500px;
            min-width: 500px;
            background: gray;
            right: 0;
            top: 200px
        }

        .back {
            position: fixed;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            top: 0;
            left: 0;
        }

        #drop {
            border: 2px dashed #bbb;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            font: 20pt bold, "Vollkorn";
            color: #bbb
        }

        #b64data {
            width: 100%;
        }

        a {
            text-decoration: none
        }

        .hide {
            display: none;
        }

        .show {
            display: block;
        }

        textarea {
            height: 400px;
            width: 300px;
        }
    </style>
</head>

<body>
    <div id="back" class="back"></div>
    <pre>

<select name="format" onchange="setfmt()" class="hide">
<option value="csv" selected> CSV</option>
<!-- <option value="json"> JSON</option> -->
<!-- <option value="form"> FORMULAE</option> -->
<!-- <option value="html"> HTML</option> -->
</select><br />
<div id="drop">Drop a spreadsheet file here to see sheet data</div>
<input type="file" name="xlfile" id="xlf" /> ... or click here to select a file

</pre>
    <input id="files" type="file" webkitdirectory class="hide">

    <pre id="out"></pre>
    <div id="htmlout"></div>

    <div id="emailcon">
        <b>Items Found: <i id="icount">0</i></b>
        <button onclick="savecsv()">Download CSV</button>
        <h4 id="sheetname"></h4>
        <textarea id="emailout" readonly></textarea>
    </div>

    <br />

    <pre id="log">

    </pre>
    <!-- uncomment the next line here and in xlsxworker.js for encoding support -->
    <script src="js/cpexcel.js"></script>
    <script src="js/shim.js"></script>
    <script src="js/jszip.js"></script>
    <script src="js/xlsx.js"></script>
    <script src="js/jquery.js"></script>
    <script>
        /*jshint browser:true */
        /* eslint-env browser */
        /* eslint no-use-before-define:0 */
        /*global Uint8Array, Uint16Array, ArrayBuffer */
        /*global XLSX */
        var X = XLSX;
        var XW = {
            /* worker message */
            msg: 'xlsx',
        };

        var rABS = typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";

        var wtf_mode = false;

        function fixdata(data) {
            var o = "",
                l = 0,
                w = 10240;
            for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
            o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
            return o;
        }

        function ab2str(data) {
            var o = "",
                l = 0,
                w = 10240;
            for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint16Array(data.slice(l * w, l * w + w)));
            o += String.fromCharCode.apply(null, new Uint16Array(data.slice(l * w)));
            return o;
        }

        function s2ab(s) {
            var b = new ArrayBuffer(s.length * 2),
                v = new Uint16Array(b);
            for (var i = 0; i != s.length; ++i) v[i] = s.charCodeAt(i);
            return [v, b];
        }

        function get_radio_value(radioName) {
            var radios = document.getElementsByName(radioName);
            for (var i = 0; i < radios.length; i++) {
                if (radios[i].checked || radios.length === 1) {
                    return radios[i].value;
                }
            }
        }

        function to_json(workbook) {
            var result = {};
            workbook.SheetNames.forEach(function(sheetName) {
                var roa = X.utils.sheet_to_json(workbook.Sheets[sheetName]);
                if (roa.length > 0) {
                    result[sheetName] = roa;
                }
            });
            return result;
        }

        function to_csv(workbook) {
            $('#back').show();

            setTimeout(function() {

                var cnt = 0;
                var txtarea = $('#emailout');
                workbook.SheetNames.forEach(function(sheetName) {
                    var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
                    if (csv.length > 0 && csv !== null) {
                        var em = extractEmails(csv);
                        cnt += em.length;
                        txtarea.val(txtarea.val() + em.join('\n'));
                    }
                });

                var vals = $('#emailout').val().split('\n');
                var un = getUnique(vals);
                txtarea.val('');
                txtarea.val(txtarea.val() + un.join('\n'));
                $('#icount').html(un.length);
                $('#back').hide();

            }, 500);
        }

        $('#back').hide();

        function extractEmails(text) {
            var m = text.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);
            if (!m)
                return [];

            return getUnique(m);
        }

        function getUnique(m) {
            var uniqueNames = [];
            $.each(m, function(i, el) {
                if ($.inArray(el, uniqueNames) === -1) uniqueNames.push(el);
            });
            return uniqueNames;
        };

        function to_formulae(workbook) {
            var result = [];
            workbook.SheetNames.forEach(function(sheetName) {
                var formulae = X.utils.get_formulae(workbook.Sheets[sheetName]);
                if (formulae.length > 0) {
                    result.push("SHEET: " + sheetName);
                    result.push("");
                    result.push(formulae.join("\n"));
                }
            });
            return result.join("\n");
        }

        var HTMLOUT = document.getElementById('htmlout');
        var OUT = document.getElementById('out');

        function to_html(workbook) {
            HTMLOUT.innerHTML = "";
            OUT.innerHTML = "";
            workbook.SheetNames.forEach(function(sheetName) {
                var htmlstr = X.write(workbook, {
                    sheet: sheetName,
                    type: 'binary',
                    bookType: 'html'
                });
                HTMLOUT.innerHTML += htmlstr;
            });
        }

        var tarea = document.getElementById('b64data');

        function b64it() {
            if (typeof console !== 'undefined') console.log("onload", new Date());
            var wb = X.read(tarea.value, {
                type: 'base64',
                WTF: wtf_mode
            });
            process_wb(wb);
        }
        window.b64it = b64it;

        var global_wb;

        function process_wb(wb) {
            global_wb = wb;
            var output = "";
            switch (get_radio_value("format")) {
                case "json":
                    output = JSON.stringify(to_json(wb), 2, 2);
                    break;
                case "form":
                    output = to_formulae(wb);
                    break;
                case "html":
                    return to_html(wb);
                default:
                    output = to_csv(wb);
            }

            // if (OUT.innerText === undefined) OUT.textContent = output;
            // else OUT.innerText = output;
            if (typeof console !== 'undefined') console.log("output", new Date());
        }

        function setfmt() {
            if (global_wb) process_wb(global_wb);
        }
        window.setfmt = setfmt;

        var drop = document.getElementById('drop');

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            var files = e.dataTransfer.files;
            var f = files[0]; {
                var reader = new FileReader();
                //var name = f.name;
                reader.onload = function(e) {
                    if (typeof console !== 'undefined') console.log("onload", new Date());
                    var data = e.target.result;

                    var wb;
                    if (rABS) {
                        wb = X.read(data, {
                            type: 'binary'
                        });
                    } else {
                        var arr = fixdata(data);
                        wb = X.read(btoa(arr), {
                            type: 'base64'
                        });
                    }
                    process_wb(wb);

                };
                if (rABS) reader.readAsBinaryString(f);
                else reader.readAsArrayBuffer(f);
            }
        }

        function handleDragover(e) {
            e.stopPropagation();
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }

        if (drop.addEventListener) {
            drop.addEventListener('dragenter', handleDragover, false);
            drop.addEventListener('dragover', handleDragover, false);
            drop.addEventListener('drop', handleDrop, false);
        }


        var xlf = document.getElementById('xlf');

        function handleFile(e) {
            var files = e.target.files;
            var f = files[0]; {
                var reader = new FileReader();
                //var name = f.name;
                reader.onload = function(e) {
                    if (typeof console !== 'undefined') console.log("onload", new Date(), rABS);
                    var data = e.target.result;

                    var wb;
                    if (rABS) {
                        wb = X.read(data, {
                            type: 'binary'
                        });
                    } else {
                        var arr = fixdata(data);
                        wb = X.read(btoa(arr), {
                            type: 'base64'
                        });
                    }
                    process_wb(wb);

                };
                if (rABS) reader.readAsBinaryString(f);
                else reader.readAsArrayBuffer(f);
            }
        }

        if (xlf.addEventListener) xlf.addEventListener('change', handleFile, false);

        function getLineCount() {
            var lines = $('#emailout').val().split('\n');
            var count = 0;
            lines.forEach(function(line) {
                if (/(?:\b)(\d*\.?\d+|\d{1,3}(?:,\d{3})*(?:\.\d+)?)(?!\S)/.test(line)) {
                    count++;
                }
            });
            return count;
        }

        function savecsv() {
            var arrayOfLines = $('#emailout').val();
            var hiddenElement = document.createElement('a');
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(arrayOfLines);
            hiddenElement.target = '_blank';
            hiddenElement.download = Date.now() + '.csv';
            hiddenElement.click();
        }

        (function() {
            var old = console.log;
            var logger = document.getElementById('log');
            console.log = function(message) {
                if (typeof message == 'object') {
                    logger.innerHTML += (JSON && JSON.stringify ? JSON.stringify(message) : message) + '<br />';
                } else {
                    logger.innerHTML += message + '<br />';
                }
            }
        })();
    </script>
</body>

</html>
